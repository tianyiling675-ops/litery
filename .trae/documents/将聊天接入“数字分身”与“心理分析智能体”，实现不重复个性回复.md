## 问题原因
- 当前聊天回复来自前端固定文案数组（src/components/ChatInterface.tsx），未接入真实智能体，导致重复、空泛。
- 生成分身时的心理分析为前端占位，未调用“心理分析智能体”。

## 目标
- 生成分身阶段调用“心理分析智能体”，产出结构化性格分析报告。
- 聊天阶段调用“数字分身”智能体，基于分析报告与用户对话历史生成个性化、不重复的回复。
- 明确“另一个我”的对话身份规范，并保留安全守护（自伤/抑郁倾向中断对话）。

## 技术方案
### 1) 引入 Agent Bridge（前端服务适配层）
- 新增 `src/services/agentBridge.ts`
- 提供两个方法：
  - `analyzeText({ text, mode, name })` → 调用“心理分析智能体”，返回 `AnalysisReport`（traits、style、riskSignals、summary）。
  - `chatWithPersona({ messages, avatar, analysisReport })` → 调用“数字分身”智能体，返回可流式或完整回复。
- 可配置化：支持后端 API 或本地代理；通过环境变量配置端点与密钥。

### 2) 生成分身阶段接入心理分析
- 修改 `src/components/Hero.tsx`：
  - `getMaxLength()` 固定 diary 上限为 10000（已调整）。
  - 在 `handleGenerate()` 中：
    - 调用 `agentBridge.analyzeText()` 获取 `analysisReport`。
    - 将 `analysisReport` 合并到 `generatedAvatar`，并在导航到 `/chat` 时一并传递。

### 3) 聊天阶段接入数字分身并避免重复
- 修改 `src/components/ChatInterface.tsx`：
  - 移除固定 `avatarResponses` 数组。
  - 在 `sendMessage()` 中调用 `agentBridge.chatWithPersona()`，入参包含：
    - `messages`（含历史），`avatar.name`、`avatar.personality`、`analysisReport`。
    - `system_guidelines`：以“世上另一个我”的身份、第一人称表达、贴近用户语言风格与价值观。
  - 防重复策略：
    - 对比上一条回复的文本，相似度>0.85 时重试一次（增加 `avoid_repeat=true`），最多 2 次。
    - 若仍失败，生成基于 `analysisReport` 的本地 fallback：将用户信息点化为具体建议与共鸣表达。
  - 维持安全守护：
    - 现有本地检测保留并拓展关键词集；触发后锁定输入、弹出求助信息。

### 4) 对话身份与语气规范
- 为“数字分身”构建统一 system 约束：
  - 始终以用户的“另一个我”身份说话，用第一人称；
  - 使用用户在“心理分析智能体”报告中的词汇偏好与价值倾向；
  - 给出具体、可执行的建议，避免空泛语句与重复套话；
  - 保留温柔、尊重边界的风格；在情感话题时优先共情与反映。

### 5) UI/UX
- 保留对话页右上角“添加到网页”按钮与重命名校验（已实现）。
- 在聊天头部展示“智能体来源”小标签：`心理分析：已启用` / `数字分身：已启用`。
- 在回复区域加入“生成中…”的渐进动画与流式文本呈现（如果后端支持 SSE/流）。

### 6) 接口约定（可与后端联调）
- POST `/agents/psych/analyze`
  - req: `{ text, mode, name }`
  - res: `{ summary, traits[], writingStyle, riskSignals[] }`
- POST `/agents/avatar/chat`
  - req: `{ messages, avatar: { name, personality }, analysisReport, avoid_repeat? }`
  - res: `{ reply, meta: { usedAvoidRepeat, tokens } }` 或流式事件。

### 7) 安全策略强化
- 扩充危机词库；引入简单情感分数判定（如负向阈值时触发守护）。
- 触发后提供本地化热线（可后续按地区配置），并允许“我了解了”后解锁但二次提醒。

### 8) 测试与验收
- 单元测试：危机检测函数、重复回复拦截。
- 联调测试：
  - 长文本（≥2000字）分析返回稳定报告；
  - 连续 5 轮对话，无明显重复；
  - 触发危机时，输入锁定与提示生效。
- 端到端：生成 → 对话 → 添加到网页 → 示例展示。

### 9) 交付与配置
- 在 `.env` 中配置两个端点与密钥；提供示例 `.env.local.example`。
- 文档说明如何替换为你现有的“心理分析智能体”和“数字分身”服务。

## 预计改动文件
- 新增：`src/services/agentBridge.ts`
- 修改：`src/components/Hero.tsx`、`src/components/ChatInterface.tsx`
- 可选：`src/components/Header.tsx`（显示智能体状态徽标）

请确认以上方案，我将按此实现并与实际智能体端点联调，确保聊天即刻由“数字分身”生成个性化、不重复的回复，分析由“心理分析智能体”提供。